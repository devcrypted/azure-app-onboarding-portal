{% extends "base.html" %}

{% block title %}Manage Lookup Data - TradeX Platform Onboarding{% endblock %}

{% block content %}
<div class="px-4 sm:px-0" x-data="lookupManagementApp()" x-init="init()">
    <h1 class="text-3xl font-bold text-gray-900">Manage Lookup Data</h1>
    <p class="mt-2 text-sm text-gray-600">Configure organizations, LOBs, environments, and regions</p>

    <div class="mt-8 grid grid-cols-1 gap-6 lg:grid-cols-2">
        <!-- Add New Lookup Data -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4">Add New Entry</h2>

                <form @submit.prevent="addEntry" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Field Type</label>
                        <select x-model="newEntry.field" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            <option value="">Select field type</option>
                            <option value="Organization">Organization</option>
                            <option value="LOB">Line of Business</option>
                            <option value="Environment">Environment</option>
                            <option value="Region">Region</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Value</label>
                        <input type="text" x-model="newEntry.value" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                               placeholder="e.g., Digital Platform">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Abbreviation</label>
                        <input type="text" x-model="newEntry.abbreviation" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                               placeholder="e.g., DP"
                               maxlength="10">
                    </div>

                    <div x-show="errorMessage" class="rounded-md bg-red-50 p-3">
                        <p class="text-sm text-red-800" x-text="errorMessage"></p>
                    </div>

                    <button type="submit" :disabled="submitting"
                            class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50">
                        <span x-show="!submitting">Add Entry</span>
                        <span x-show="submitting">Adding...</span>
                    </button>
                </form>
            </div>
        </div>

        <!-- Existing Lookup Data -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4">Current Lookup Data</h2>

                <div x-show="loading" class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                </div>

                <div x-show="!loading" class="space-y-4 max-h-96 overflow-y-auto">
                    <template x-for="(items, field) in lookupData" :key="field">
                        <div>
                            <h3 class="text-sm font-semibold text-gray-700 mb-2" x-text="field"></h3>
                            <ul class="space-y-1">
                                <template x-for="item in items" :key="item.id">
                                    <li class="flex items-center justify-between p-2 bg-gray-50 rounded text-sm">
                                        <div>
                                            <span class="font-medium" x-text="item.value"></span>
                                            <span class="text-gray-500 ml-2">(<span x-text="item.abbreviation"></span>)</span>
                                        </div>
                                    </li>
                                </template>
                            </ul>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-6">
        <a href="{{ url_for('web.admin_panel') }}" class="text-sm text-blue-600 hover:text-blue-800">
            ‚Üê Back to Admin Panel
        </a>
    </div>
</div>

<script>
function lookupManagementApp() {
    return {
        lookupData: {},
        newEntry: {
            field: '',
            value: '',
            abbreviation: ''
        },
        loading: true,
        submitting: false,
        errorMessage: '',

        async init() {
            await this.loadLookupData();
        },

        async loadLookupData() {
            this.loading = true;
            try {
                const response = await fetch('/api/lookup');
                this.lookupData = await response.json();
            } catch (error) {
                console.error('Failed to load lookup data:', error);
            } finally {
                this.loading = false;
            }
        },

        async addEntry() {
            this.submitting = true;
            this.errorMessage = '';

            try {
                const response = await fetch('/api/lookup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Email': '{{ user_email }}'
                    },
                    body: JSON.stringify(this.newEntry)
                });

                if (response.ok) {
                    // Reset form
                    this.newEntry = { field: '', value: '', abbreviation: '' };
                    // Reload data
                    await this.loadLookupData();
                } else {
                    const data = await response.json();
                    this.errorMessage = data.error || 'Failed to add entry';
                }
            } catch (error) {
                this.errorMessage = 'Network error: ' + error.message;
            } finally {
                this.submitting = false;
            }
        }
    };
}
</script>
{% endblock %}
