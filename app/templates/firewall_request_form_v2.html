{% extends "base.html" %}
{% from "icons.html" import icon_submit, icon_spinner %}

{% block title %}New Firewall Request - TradeX Platform Onboarding{% endblock %}

{% block content %}
<div x-data="firewallRequestApp()" x-init="init()" class="container mx-auto py-8 px-4">
    <div class="max-w-6xl mx-auto space-y-6">
        <div class="flex items-start justify-between gap-6 flex-wrap">
            <div>
                <h1 class="text-3xl font-bold tracking-tight">New Firewall Request</h1>
                <p class="text-muted-foreground mt-2 max-w-2xl">
                    Submit firewall rules for network access approval.
                </p>
            </div>
            <a href="{{ url_for('web.dashboard') }}" class="btn btn-muted">Back</a>
        </div>

        <!-- Alerts -->
        <template x-if="errorMessage">
            <div class="rounded-lg border-2 border-red-400 bg-red-50 dark:bg-red-900/20 p-5" role="alert">
                <div class="flex items-start gap-3">
                    <svg class="h-6 w-6 text-red-600" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-11.5a.75.75 0 10-1.5 0v4a.75.75 0 001.5 0v-4zm0 6a.75.75 0 10-1.5 0 .75.75 0 001.5 0z" clip-rule="evenodd" />
                    </svg>
                    <div class="space-y-1">
                        <h3 class="text-sm font-semibold text-red-800">Unable to submit request</h3>
                        <p class="text-sm text-red-700" x-text="errorMessage"></p>
                        <template x-if="validationErrors.length">
                            <ul class="mt-3 text-sm text-red-700 space-y-2 border-t border-red-200 pt-3">
                                <template x-for="(err, idx) in validationErrors" :key="idx">
                                    <li class="flex items-start gap-2">
                                        <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                        </svg>
                                        <div>
                                            <span class="font-semibold" x-text="err.field"></span>: 
                                            <span x-text="err.message || err.msg"></span>
                                        </div>
                                    </li>
                                </template>
                            </ul>
                        </template>
                    </div>
                </div>
            </div>
        </template>

        <template x-if="successMessage">
            <div class="rounded-lg border border-green-300 bg-green-50 p-4" role="alert">
                <div class="flex items-start gap-3">
                    <svg class="h-5 w-5 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-10.809a.75.75 0 10-1.214-.882l-3.54 4.866-1.773-1.773a.75.75 0 10-1.06 1.06l2.5 2.5a.75.75 0 001.14-.067l4-5.5z" clip-rule="evenodd" />
                    </svg>
                    <div>
                        <p class="text-sm font-medium text-green-800" x-text="successMessage"></p>
                        <a class="text-sm text-primary underline mt-1 block" :href="redirectUrl">View request details</a>
                    </div>
                </div>
            </div>
        </template>

        <form @submit.prevent="submitRequest" class="space-y-6">
            <!-- Request metadata -->
            <div class="card bg-white dark:bg-gray-800">
                <div class="p-6 space-y-5">
                    <h2 class="text-lg font-semibold">Request Details</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <!-- Source Application ID -->
                        <div class="space-y-1.5 md:col-span-2">
                            <label class="flex items-center gap-2 text-sm font-medium text-muted-foreground">
                                Application ID *
                                <span class="relative inline-block">
                                    <button type="button" @click="showingTooltip = showingTooltip === 'appId' ? '' : 'appId'" 
                                            class="text-blue-500 hover:text-blue-700 focus:outline-none">ⓘ</button>
                                    <div x-show="showingTooltip === 'appId'" 
                                         @click.outside="showingTooltip = ''"
                                         x-transition
                                         class="absolute z-10 w-72 p-3 mt-2 text-sm bg-gray-900 text-white rounded-lg shadow-lg left-0"
                                         style="display: none;">
                                        Enter the numeric ID, app code (e.g., APP-00001), or slug of an existing application. This will auto-populate application details.
                                        <div class="absolute -top-1 left-4 w-2 h-2 bg-gray-900 transform rotate-45"></div>
                                    </div>
                                </span>
                            </label>
                            <input 
                                type="text" 
                                x-model="form.source_application_id" 
                                @blur="loadSourceApplicationDetails"
                                required
                                class="input w-full" 
                                placeholder="Enter application ID, app code, or slug" 
                            />
                        </div>

                        <!-- Collection Name (Auto-generated, disabled) -->
                        <div class="space-y-1.5 md:col-span-2">
                            <label class="flex items-center gap-2 text-sm font-medium text-muted-foreground">
                                Collection Name
                                <span class="relative inline-block">
                                    <button type="button" @click="showingTooltip = showingTooltip === 'collectionName' ? '' : 'collectionName'" 
                                            class="text-blue-500 hover:text-blue-700 focus:outline-none">ⓘ</button>
                                    <div x-show="showingTooltip === 'collectionName'" 
                                         @click.outside="showingTooltip = ''"
                                         x-transition
                                         class="absolute z-10 w-64 p-3 mt-2 text-sm bg-gray-900 text-white rounded-lg shadow-lg left-0"
                                         style="display: none;">
                                        Auto-generated from the application name in lowercase with hyphens.
                                        <div class="absolute -top-1 left-4 w-2 h-2 bg-gray-900 transform rotate-45"></div>
                                    </div>
                                </span>
                            </label>
                            <input 
                                type="text" 
                                x-model="form.collection_name" 
                                disabled
                                class="input w-full bg-muted/30 cursor-not-allowed" 
                                placeholder="Auto-generated from app name"
                            />
                        </div>

                        <!-- Application Name (Auto-populated) -->
                        <div class="space-y-1.5">
                            <label class="flex items-center gap-2 text-sm font-medium text-muted-foreground">
                                Application Name
                                <span class="relative inline-block">
                                    <button type="button" @click="showingTooltip = showingTooltip === 'appName' ? '' : 'appName'" 
                                            class="text-blue-500 hover:text-blue-700 focus:outline-none">ⓘ</button>
                                    <div x-show="showingTooltip === 'appName'" 
                                         @click.outside="showingTooltip = ''"
                                         x-transition
                                         class="absolute z-10 w-64 p-3 mt-2 text-sm bg-gray-900 text-white rounded-lg shadow-lg left-0"
                                         style="display: none;">
                                        Auto-populated when you enter a valid application ID.
                                        <div class="absolute -top-1 left-4 w-2 h-2 bg-gray-900 transform rotate-45"></div>
                                    </div>
                                </span>
                            </label>
                            <input 
                                type="text" 
                                x-model="form.application_name" 
                                readonly
                                class="input w-full bg-muted/30 text-muted-foreground cursor-not-allowed" 
                                placeholder="Auto-populated"
                            />
                        </div>

                        <!-- Organization (Auto-populated) -->
                        <div class="space-y-1.5">
                            <label class="text-sm font-medium text-muted-foreground">Organization</label>
                            <input 
                                type="text" 
                                x-model="form.organization" 
                                readonly
                                class="input w-full bg-muted/30 text-muted-foreground cursor-not-allowed" 
                                placeholder="Auto-populated"
                            />
                        </div>

                        <!-- LOB (Auto-populated) -->
                        <div class="space-y-1.5">
                            <label class="text-sm font-medium text-muted-foreground">Line of Business</label>
                            <input 
                                type="text" 
                                x-model="form.lob" 
                                readonly
                                class="input w-full bg-muted/30 text-muted-foreground cursor-not-allowed" 
                                placeholder="Auto-populated"
                            />
                        </div>

                        <!-- Environment Scopes -->
                        <div class="space-y-1.5 md:col-span-2" x-show="availableEnvironmentScopes.length > 0">
                            <label class="flex items-center gap-2 text-sm font-medium">
                                Environment Scopes *
                                <button type="button" class="text-muted-foreground hover:text-foreground" title="Select the environments where these rules should apply">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </label>
                            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2">
                                <template x-for="scope in availableEnvironmentScopes" :key="scope">
                                    <label class="flex items-center gap-2 rounded border px-3 py-2 cursor-pointer transition-colors"
                                           :class="form.environment_scopes.includes(scope) ? 'border-primary bg-primary/10 text-primary font-medium' : 'border-border hover:border-primary/50'">
                                        <input type="checkbox" class="checkbox" :value="scope" @change="toggleEnvironmentScope(scope); validateField('environment_scopes', form.environment_scopes)" :checked="form.environment_scopes.includes(scope)" />
                                        <span class="text-sm" x-text="scope"></span>
                                    </label>
                                </template>
                            </div>
                            <p x-show="fieldErrors.environment_scopes" x-text="fieldErrors.environment_scopes" class="text-sm text-red-600 mt-1"></p>
                        </div>

                        <!-- Justification -->
                        <div class="space-y-1.5 md:col-span-2">
                            <label class="flex items-center gap-2 text-sm font-medium">
                                Business Justification *
                                <button type="button" class="text-muted-foreground hover:text-foreground" title="Explain the business need for this firewall access">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </label>
                            <textarea 
                                x-model="form.justification" 
                                @input="validateField('justification', form.justification)"
                                @blur="validateField('justification', form.justification)"
                                rows="3" 
                                required 
                                :class="fieldErrors.justification ? 'input w-full resize-y border-red-500 focus:border-red-500 focus:ring-red-500' : 'input w-full resize-y'" 
                                placeholder="Describe the business need for this access... (minimum 10 characters)"></textarea>
                            <p x-show="fieldErrors.justification" x-text="fieldErrors.justification" class="text-sm text-red-600 mt-1"></p>
                            <p x-show="!fieldErrors.justification && form.justification.length > 0" class="text-sm text-muted-foreground mt-1">
                                <span x-text="form.justification.trim().length"></span> characters (minimum 10 required)
                            </p>
                        </div>

                        <!-- IP Groups (JSON) - Commented out for now -->
                        <!-- <div class="space-y-1.5 md:col-span-2">
                            <label class="flex items-center gap-2 text-sm font-medium">
                                IP Groups (JSON)
                                <button type="button" class="text-muted-foreground hover:text-foreground" title="Define reusable IP groups in JSON format">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </label>
                            <textarea x-model="form.ip_groups_json" rows="2" class="input w-full resize-y font-mono text-xs" placeholder='{"group1": ["10.0.0.0/24"]}'></textarea>
                        </div> -->
                    </div>
                </div>
            </div>

            <!-- Rule Collection Tabs -->
            <div class="card bg-gray-50 dark:bg-gray-900">
                <div class="border-b border-border">
                    <nav class="flex gap-1 p-1.5">
                        <button 
                            type="button"
                            @click="activeTab = 'application'"
                            class="px-4 py-2.5 text-sm font-medium rounded-md transition-all"
                            :class="activeTab === 'application' ? 'bg-white dark:bg-gray-800 text-primary shadow-sm' : 'text-muted-foreground hover:text-foreground'"
                        >
                            Application <span class="ml-1.5 text-xs" x-text="`(${form.application_rules.rules.length})`"></span>
                        </button>
                        <button 
                            type="button"
                            @click="activeTab = 'network'"
                            class="px-4 py-2.5 text-sm font-medium rounded-md transition-all"
                            :class="activeTab === 'network' ? 'bg-white dark:bg-gray-800 text-primary shadow-sm' : 'text-muted-foreground hover:text-foreground'"
                        >
                            Network <span class="ml-1.5 text-xs" x-text="`(${form.network_rules.rules.length})`"></span>
                        </button>
                        <button 
                            type="button"
                            @click="activeTab = 'nat'"
                            class="px-4 py-2.5 text-sm font-medium rounded-md transition-all"
                            :class="activeTab === 'nat' ? 'bg-white dark:bg-gray-800 text-primary shadow-sm' : 'text-muted-foreground hover:text-foreground'"
                        >
                            NAT <span class="ml-1.5 text-xs" x-text="`(${form.nat_rules.rules.length})`"></span>
                        </button>
                    </nav>
                </div>

                <!-- Application Rules Tab -->
                <div x-show="activeTab === 'application'" class="p-6 space-y-4">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <h3 class="text-base font-semibold">Application Rules</h3>
                            <button type="button" class="text-muted-foreground hover:text-foreground" title="FQDN-based filtering for HTTP/HTTPS application traffic">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary" @click="addApplicationRule">+ Add Rule</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-3 pt-1">
                        <div class="space-y-1.5">
                            <label class="text-sm font-medium">Action</label>
                            <select x-model="form.application_rules.action" class="input w-full">
                                <option value="Allow">Allow</option>
                                <option value="Deny">Deny</option>
                            </select>
                        </div>
                        <div class="space-y-1.5">
                            <label class="flex items-center gap-2 text-sm font-medium">
                                Priority
                                <button type="button" class="text-muted-foreground hover:text-foreground" title="Auto-calculated based on existing rules">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </label>
                            <input type="text" value="Auto-calculated" disabled class="input w-full bg-muted/30 cursor-not-allowed" />
                        </div>
                    </div>
                    <div class="space-y-3">
                        <template x-for="(rule, index) in form.application_rules.rules" :key="index">
                            <div class="bg-white dark:bg-gray-800 border border-border rounded-lg p-4 space-y-3 shadow-sm">
                                <div class="flex justify-between items-center pb-2 border-b border-border/50">
                                    <span class="text-sm font-semibold text-primary">Rule <span x-text="index + 1"></span></span>
                                    <button type="button" class="text-xs text-red-600 hover:text-red-700 font-medium" @click="removeApplicationRule(index)">Remove</button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium text-muted-foreground">Name * <span class="text-muted-foreground/60">(letters, numbers, _, - only)</span></label>
                                        <input 
                                            type="text" 
                                            x-model="rule.name" 
                                            @input="validateRuleName(rule, rule.name)"
                                            @blur="validateRuleName(rule, rule.name)"
                                            required 
                                            :class="rule.nameError ? 'input input-sm w-full border-red-500 focus:border-red-500 focus:ring-red-500' : 'input input-sm w-full'" 
                                            placeholder="allow_api_access or allow-api-access" />
                                        <p x-show="rule.nameError" x-text="rule.nameError" class="text-xs text-red-600 mt-0.5"></p>
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium text-muted-foreground">RITM Number</label>
                                        <input type="text" x-model="rule.ritm_number" class="input input-sm w-full" placeholder="Optional" />
                                    </div>
                                    <div class="space-y-1 md:col-span-2">
                                        <label class="text-xs font-medium text-muted-foreground">Description</label>
                                        <input type="text" x-model="rule.description" class="input input-sm w-full" placeholder="Brief description of rule purpose" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium text-muted-foreground">Source IPs *</label>
                                        <input type="text" x-model="rule.source_ip_addresses" required class="input input-sm w-full" placeholder="10.0.0.0/24" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium text-muted-foreground">Protocols * <span class="text-muted-foreground/70">(Format: Https:443 or Http:80)</span></label>
                                        <input 
                                            type="text" 
                                            x-model="rule.protocols_text" 
                                            @input="validateRuleProtocols(rule, rule.protocols_text)"
                                            @blur="validateRuleProtocols(rule, rule.protocols_text)"
                                            required 
                                            :class="rule.protocolsError ? 'input input-sm w-full border-red-500 focus:border-red-500 focus:ring-red-500' : 'input input-sm w-full'" 
                                            placeholder="Https:443, Http:80" />
                                        <p x-show="rule.protocolsError" x-text="rule.protocolsError" class="text-xs text-red-600 mt-0.5"></p>
                                        <p x-show="!rule.protocolsError && rule.protocols_text" class="text-xs text-green-600 mt-0.5">
                                            ✓ Valid protocol format
                                        </p>
                                    </div>
                                    <div class="space-y-1 md:col-span-2">
                                        <label class="text-xs font-medium text-muted-foreground">Destination FQDNs <span class="text-muted-foreground/70">(e.g., example.com or *.example.com)</span></label>
                                        <input 
                                            type="text" 
                                            x-model="rule.destination_fqdns" 
                                            @input="validateRuleFQDN(rule, rule.destination_fqdns)"
                                            @blur="validateRuleFQDN(rule, rule.destination_fqdns)"
                                            :class="rule.fqdnError ? 'input input-sm w-full border-red-500 focus:border-red-500 focus:ring-red-500' : 'input input-sm w-full'" 
                                            placeholder="*.example.com, api.service.com" />
                                        <p x-show="rule.fqdnError" x-text="rule.fqdnError" class="text-xs text-red-600 mt-0.5"></p>
                                    </div>
                                    <!-- Less common fields hidden by default -->
                                    <template x-if="false">
                                        <div class="space-y-1">
                                            <label class="text-xs font-medium text-muted-foreground">Source IP Groups</label>
                                            <input type="text" x-model="rule.source_ip_groups" class="input input-sm w-full" placeholder="Optional" />
                                        </div>
                                    </template>
                                    <template x-if="false">
                                        <div class="space-y-1">
                                            <label class="text-xs font-medium text-muted-foreground">Destination IPs</label>
                                            <input type="text" x-model="rule.destination_addresses" class="input input-sm w-full" placeholder="Optional" />
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Network Rules Tab -->
                <div x-show="activeTab === 'network'" class="p-6 space-y-4">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <h3 class="text-base font-semibold">Network Rules</h3>
                            <button type="button" class="text-muted-foreground hover:text-foreground" title="IP-based filtering for TCP/UDP network traffic">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary" @click="addNetworkRule">+ Add Rule</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-3 pt-1">
                        <div class="space-y-1.5">
                            <label class="text-sm font-medium">Action</label>
                            <select x-model="form.network_rules.action" class="input w-full">
                                <option value="Allow">Allow</option>
                                <option value="Deny">Deny</option>
                            </select>
                        </div>
                        <div class="space-y-1.5">
                            <label class="flex items-center gap-2 text-sm font-medium">
                                Priority
                                <button type="button" class="text-muted-foreground hover:text-foreground" title="Auto-calculated based on existing rules">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </label>
                            <input type="text" value="Auto-calculated" disabled class="input w-full bg-muted/30 cursor-not-allowed" />
                        </div>
                    </div>
                    <div class="space-y-3">
                        <template x-for="(rule, index) in form.network_rules.rules" :key="index">
                            <div class="bg-white dark:bg-gray-800 border border-border rounded-lg p-4 space-y-3 shadow-sm">
                                <div class="flex justify-between items-center pb-2 border-b border-border/50">
                                    <span class="text-sm font-semibold text-primary">Rule <span x-text="index + 1"></span></span>
                                    <button type="button" class="text-xs text-red-600 hover:text-red-700 font-medium" @click="removeNetworkRule(index)">Remove</button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium text-muted-foreground">Name *</label>
                                        <input 
                                            type="text" 
                                            x-model="rule.name" 
                                            @input="validateRuleName(rule, rule.name)"
                                            @blur="validateRuleName(rule, rule.name)"
                                            required 
                                            :class="{'border-red-500': rule.nameError}" 
                                            class="input input-sm w-full" 
                                            placeholder="allow-sql-access" 
                                        />
                                        <p x-show="rule.nameError" x-text="rule.nameError" class="text-xs text-red-600 mt-1"></p>
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium text-muted-foreground">RITM Number</label>
                                        <input type="text" x-model="rule.ritm_number" class="input input-sm w-full" placeholder="Optional" />
                                    </div>
                                    <div class="space-y-1 md:col-span-2">
                                        <label class="text-xs font-medium text-muted-foreground">Description</label>
                                        <input type="text" x-model="rule.description" class="input input-sm w-full" placeholder="Brief description of rule purpose" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium text-muted-foreground">Protocols * <span class="text-muted-foreground/70">(e.g., TCP)</span></label>
                                        <input 
                                            type="text" 
                                            x-model="rule.protocols" 
                                            @input="validateNetworkProtocols(rule, rule.protocols)"
                                            @blur="validateNetworkProtocols(rule, rule.protocols)"
                                            required 
                                            :class="{'border-red-500': rule.protocolsError}" 
                                            class="input input-sm w-full" 
                                            placeholder="TCP, UDP" 
                                        />
                                        <p x-show="rule.protocolsError" x-text="rule.protocolsError" class="text-xs text-red-600 mt-1"></p>
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium text-muted-foreground">Destination Ports *</label>
                                        <input 
                                            type="text" 
                                            x-model="rule.destination_ports" 
                                            @input="validatePorts(rule, rule.destination_ports)"
                                            @blur="validatePorts(rule, rule.destination_ports)"
                                            required 
                                            :class="{'border-red-500': rule.portsError}" 
                                            class="input input-sm w-full" 
                                            placeholder="443, 1433" 
                                        />
                                        <p x-show="rule.portsError" x-text="rule.portsError" class="text-xs text-red-600 mt-1"></p>
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium text-muted-foreground">Source IPs *</label>
                                        <input type="text" x-model="rule.source_ip_addresses" required class="input input-sm w-full" placeholder="10.0.0.0/24" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium text-muted-foreground">Destination IPs *</label>
                                        <input type="text" x-model="rule.destination_ip_addresses" required class="input input-sm w-full" placeholder="10.1.0.0/24" />
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- NAT Rules Tab -->
                <div x-show="activeTab === 'nat'" class="p-6 space-y-4">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <h3 class="text-base font-semibold">NAT Rules</h3>
                            <button type="button" class="text-muted-foreground hover:text-foreground" title="Network address translation for inbound/outbound traffic">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary" @click="addNatRule">+ Add Rule</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-3 pt-1">
                        <div class="space-y-1.5">
                            <label class="text-sm font-medium">Action</label>
                            <select x-model="form.nat_rules.action" class="input w-full">
                                <option value="Dnat">Dnat</option>
                                <option value="Snat">Snat</option>
                            </select>
                        </div>
                        <div class="space-y-1.5">
                            <label class="flex items-center gap-2 text-sm font-medium">
                                Priority
                                <button type="button" class="text-muted-foreground hover:text-foreground" title="Auto-calculated based on existing rules">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </label>
                            <input type="text" value="Auto-calculated" disabled class="input w-full bg-muted/30 cursor-not-allowed" />
                        </div>
                    </div>
                    <div class="space-y-3">
                        <template x-for="(rule, index) in form.nat_rules.rules" :key="index">
                            <div class="bg-white dark:bg-gray-800 border border-border rounded-lg p-4 space-y-3 shadow-sm">
                                <div class="flex justify-between items-center pb-2 border-b border-border/50">
                                    <span class="text-sm font-semibold text-primary">Rule <span x-text="index + 1"></span></span>
                                    <button type="button" class="text-xs text-red-600 hover:text-red-700 font-medium" @click="removeNatRule(index)">Remove</button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium text-muted-foreground">Name *</label>
                                        <input 
                                            type="text" 
                                            x-model="rule.name" 
                                            @input="validateRuleName(rule, rule.name)"
                                            @blur="validateRuleName(rule, rule.name)"
                                            required 
                                            :class="{'border-red-500': rule.nameError}" 
                                            class="input input-sm w-full" 
                                            placeholder="dnat-web-server" 
                                        />
                                        <p x-show="rule.nameError" x-text="rule.nameError" class="text-xs text-red-600 mt-1"></p>
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium text-muted-foreground">RITM Number</label>
                                        <input type="text" x-model="rule.ritm_number" class="input input-sm w-full" placeholder="Optional" />
                                    </div>
                                    <div class="space-y-1 md:col-span-2">
                                        <label class="text-xs font-medium text-muted-foreground">Description</label>
                                        <input type="text" x-model="rule.description" class="input input-sm w-full" placeholder="Brief description of rule purpose" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium text-muted-foreground">Protocols * <span class="text-muted-foreground/70">(e.g., TCP)</span></label>
                                        <input 
                                            type="text" 
                                            x-model="rule.protocols" 
                                            @input="validateNetworkProtocols(rule, rule.protocols)"
                                            @blur="validateNetworkProtocols(rule, rule.protocols)"
                                            required 
                                            :class="{'border-red-500': rule.protocolsError}" 
                                            class="input input-sm w-full" 
                                            placeholder="TCP" 
                                        />
                                        <p x-show="rule.protocolsError" x-text="rule.protocolsError" class="text-xs text-red-600 mt-1"></p>
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium text-muted-foreground">Source IPs *</label>
                                        <input type="text" x-model="rule.source_ip_addresses" required class="input input-sm w-full" placeholder="0.0.0.0/0" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium text-muted-foreground">Destination Address *</label>
                                        <input type="text" x-model="rule.destination_address" required class="input input-sm w-full" placeholder="Public IP" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium text-muted-foreground">Destination Ports *</label>
                                        <input 
                                            type="text" 
                                            x-model="rule.destination_ports" 
                                            @input="validatePorts(rule, rule.destination_ports)"
                                            @blur="validatePorts(rule, rule.destination_ports)"
                                            required 
                                            :class="{'border-red-500': rule.portsError}" 
                                            class="input input-sm w-full" 
                                            placeholder="443" 
                                        />
                                        <p x-show="rule.portsError" x-text="rule.portsError" class="text-xs text-red-600 mt-1"></p>
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium text-muted-foreground">Translated Address *</label>
                                        <input type="text" x-model="rule.translated_address" required class="input input-sm w-full" placeholder="Internal IP" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium text-muted-foreground">Translated Port *</label>
                                        <input type="number" x-model.number="rule.translated_port" required class="input input-sm w-full" placeholder="443" min="1" max="65535" />
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Submission -->
            <div class="flex flex-col sm:flex-row gap-3 justify-end">
                <a href="{{ url_for('web.dashboard') }}" class="btn btn-muted text-center">Cancel</a>
                <button type="submit" class="btn btn-primary" :disabled="submitting">
                    <span x-show="!submitting" class="flex items-center gap-2">
                        {{ icon_submit() }} Submit for Approval
                    </span>
                    <span x-show="submitting" class="flex items-center gap-2">
                        {{ icon_spinner() }} Submitting...
                    </span>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function firewallRequestApp() {
    return {
        lookupData: { Organization: [], LOB: [], Environment: [] },
        availableEnvironmentScopes: ['DEV', 'TEST', 'QA', 'STAGE', 'UAT', 'PROD', 'DR'],
        activeTab: 'application',
        form: {
            source_application_id: '',
            collection_name: '',
            application_name: '',
            organization: '',
            lob: '',
            platform: 'Azure',
            environment_scopes: [],
            justification: '',
            requested_effective_date: '',
            expires_at: '',
            github_pr_url: '',
            ip_groups_json: '',
            application_rules: {
                action: 'Allow',
                priority: null,
                rules: []
            },
            network_rules: {
                action: 'Allow',
                priority: null,
                rules: []
            },
            nat_rules: {
                action: 'Dnat',
                priority: null,
                rules: []
            }
        },
        submitting: false,
        successMessage: '',
        errorMessage: '',
        validationErrors: [],
        redirectUrl: '#',
        showingTooltip: '',
        fieldErrors: {}, // Track errors for each field

        async init() {
            await this.loadLookupData();
        },

        // Real-time field validation
        validateField(field, value) {
            const errors = [];
            const ruleNamePattern = /^[a-zA-Z0-9_-]{1,80}$/;
            
            switch(field) {
                case 'protocols':
                    if (!value || !value.trim()) {
                        errors.push('Protocols are required');
                    } else {
                        // Check format: must be "Type:Port" like "Https:443" or "Http:80,Https:443"
                        const protocols = value.split(',').map(p => p.trim());
                        for (const protocol of protocols) {
                            if (!protocol.includes(':')) {
                                errors.push(`Invalid format: "${protocol}". Use "Https:443" or "Http:80"`);
                                break;
                            }
                            const parts = protocol.split(':');
                            if (parts.length !== 2 || !parts[0] || !parts[1]) {
                                errors.push(`Invalid format: "${protocol}". Use "Https:443" or "Http:80"`);
                                break;
                            }
                            if (isNaN(parseInt(parts[1]))) {
                                errors.push(`Port must be a number in "${protocol}"`);
                                break;
                            }
                        }
                    }
                    break;
                case 'collection_name':
                    if (!value || !value.trim()) {
                        errors.push('Collection name is required');
                    }
                    break;
                case 'application_name':
                    if (!value || !value.trim()) {
                        errors.push('Application name is required');
                    }
                    break;
                case 'organization':
                    if (!value || !value.trim()) {
                        errors.push('Organization is required');
                    }
                    break;
                case 'lob':
                    if (!value || !value.trim()) {
                        errors.push('Line of Business is required');
                    }
                    break;
                case 'platform':
                    if (!value) {
                        errors.push('Platform selection is required');
                    }
                    break;
                case 'justification':
                    if (!value || !value.trim()) {
                        errors.push('Justification is required');
                    } else if (value.trim().length < 10) {
                        errors.push('Justification must be at least 10 characters (currently ' + value.trim().length + ')');
                    }
                    break;
                case 'environment_scopes':
                    if (!value || value.length === 0) {
                        errors.push('Select at least one environment scope');
                    }
                    break;
                case 'rule_name':
                    if (!value || !value.trim()) {
                        errors.push('Rule name is required');
                    } else if (!ruleNamePattern.test(value.trim())) {
                        errors.push('Only letters, numbers, underscores, hyphens (no spaces). Example: my_rule or my-rule');
                    }
                    break;
            }
            
            if (errors.length > 0) {
                this.fieldErrors[field] = errors[0];
            } else {
                delete this.fieldErrors[field];
            }
            
            return errors.length === 0;
        },

        clearFieldError(field) {
            delete this.fieldErrors[field];
        },

        async loadLookupData() {
            try {
                const response = await fetch('/api/lookup');
                const data = await response.json();
                this.lookupData = data || { Organization: [], LOB: [], Environment: [] };
            } catch (error) {
                console.error('Failed to load lookup data', error);
            }
        },

        async loadSourceApplicationDetails() {
            const appId = this.form.source_application_id;
            
            if (!appId || appId.toString().trim() === '') {
                this.availableEnvironmentScopes = ['DEV', 'TEST', 'QA', 'STAGE', 'UAT', 'PROD', 'DR'];
                this.form.application_name = '';
                this.form.organization = '';
                this.form.lob = '';
                this.form.collection_name = '';
                this.form.environment_scopes = [];
                return;
            }

            try {
                const response = await fetch(`/api/requests/${encodeURIComponent(appId)}`);
                if (response.ok) {
                    const data = await response.json();
                    
                    // Auto-populate application details
                    this.form.application_name = data.application_name || '';
                    this.form.organization = data.organization || '';
                    this.form.lob = data.lob || '';
                    
                    // Auto-generate collection name from application name
                    if (data.application_name) {
                        this.form.collection_name = data.application_name
                            .toLowerCase()
                            .replace(/[^a-z0-9]+/g, '-')
                            .replace(/^-+|-+$/g, '');
                    }
                    
                    // Map environment names to valid schema values
                    // This handles cases where the application has "Development", "Testing" etc.
                    // but the schema expects "DEV", "TEST" etc.
                    const envMapping = {
                        'DEVELOPMENT': 'DEV',
                        'DEV': 'DEV',
                        'TESTING': 'TEST',
                        'TEST': 'TEST',
                        'QA': 'QA',
                        'QUALITY ASSURANCE': 'QA',
                        'STAGE': 'STAGE',
                        'STAGING': 'STAGE',
                        'UAT': 'UAT',
                        'USER ACCEPTANCE': 'UAT',
                        'PROD': 'PROD',
                        'PRODUCTION': 'PROD',
                        'DR': 'DR',
                        'DISASTER RECOVERY': 'DR'
                    };
                    
                    // Get available environment scopes from the application's environments
                    const envs = data.environments || [];
                    if (envs.length > 0) {
                        // Map environment names to schema-valid values
                        const mappedEnvs = envs
                            .map(e => {
                                // Safely handle undefined or null environment names
                                if (!e || !e.environment_name) return null;
                                const normalizedName = e.environment_name.toUpperCase().trim();
                                return envMapping[normalizedName] || null;
                            })
                            .filter(e => e !== null); // Remove unmapped values
                        
                        // Remove duplicates and use result only if we got valid mappings
                        const uniqueEnvs = [...new Set(mappedEnvs)];
                        this.availableEnvironmentScopes = uniqueEnvs.length > 0 
                            ? uniqueEnvs 
                            : ['DEV', 'TEST', 'QA', 'STAGE', 'UAT', 'PROD', 'DR'];
                    } else {
                        // Fallback to all valid scopes if no environments found
                        this.availableEnvironmentScopes = ['DEV', 'TEST', 'QA', 'STAGE', 'UAT', 'PROD', 'DR'];
                    }
                    
                    // Clear environment scopes that are no longer available
                    this.form.environment_scopes = this.form.environment_scopes.filter(s => this.availableEnvironmentScopes.includes(s));
                } else {
                    console.warn('Could not load source application details');
                    this.errorMessage = 'Application not found. Please check the ID, app code, or slug.';
                    this.availableEnvironmentScopes = ['DEV', 'TEST', 'QA', 'STAGE', 'UAT', 'PROD', 'DR'];
                    this.form.application_name = '';
                    this.form.organization = '';
                    this.form.lob = '';
                    this.form.collection_name = '';
                }
            } catch (error) {
                console.error('Failed to load source application', error);
                this.errorMessage = 'Failed to fetch application details. Please try again.';
                this.availableEnvironmentScopes = ['DEV', 'TEST', 'QA', 'STAGE', 'UAT', 'PROD', 'DR'];
            }
        },



        toggleEnvironmentScope(scope) {
            if (this.form.environment_scopes.includes(scope)) {
                this.form.environment_scopes = this.form.environment_scopes.filter(s => s !== scope);
            } else {
                this.form.environment_scopes.push(scope);
            }
        },

        addApplicationRule() {
            this.form.application_rules.rules.push({
                name: '',
                ritm_number: '',
                description: '',
                protocols_text: '',
                source_ip_addresses: '',
                source_ip_groups: '',
                destination_fqdns: '',
                destination_addresses: '',
                // Error tracking for this specific rule
                nameError: '',
                protocolsError: '',
                fqdnError: ''
            });
            this.activeTab = 'application';
        },

        validateRuleName(rule, value) {
            const ruleNamePattern = /^[a-zA-Z0-9_-]{1,80}$/;
            if (!value || !value.trim()) {
                rule.nameError = 'Rule name is required';
            } else if (!ruleNamePattern.test(value.trim())) {
                rule.nameError = 'Only letters, numbers, underscores, hyphens (no spaces)';
            } else {
                rule.nameError = '';
            }
        },

        validateRuleProtocols(rule, value) {
            if (!value || !value.trim()) {
                rule.protocolsError = 'Protocols are required';
                return;
            }
            
            const protocols = value.split(',').map(p => p.trim());
            for (const protocol of protocols) {
                if (!protocol.includes(':')) {
                    rule.protocolsError = `Invalid: "${protocol}". Use "Https:443"`;
                    return;
                }
                const [type, port] = protocol.split(':');
                if (!type || !port) {
                    rule.protocolsError = `Invalid: "${protocol}". Use "Https:443"`;
                    return;
                }
                if (isNaN(parseInt(port))) {
                    rule.protocolsError = `Port must be a number in "${protocol}"`;
                    return;
                }
            }
            rule.protocolsError = '';
        },

        validateRuleFQDN(rule, value) {
            if (!value || !value.trim()) {
                rule.fqdnError = '';
                return;
            }
            
            const fqdns = value.split(',').map(f => f.trim()).filter(Boolean);
            for (const fqdn of fqdns) {
                if (!fqdn.match(/^(\*\.)?[a-zA-Z0-9]([a-zA-Z0-9-]*[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]*[a-zA-Z0-9])?)*$/)) {
                    rule.fqdnError = `Invalid FQDN: "${fqdn}"`;
                    return;
                }
            }
            rule.fqdnError = '';
        },

        validateNetworkProtocols(rule, value) {
            if (!value || !value.trim()) {
                rule.protocolsError = 'Protocol is required';
                return;
            }
            
            const protocols = value.split(',').map(p => p.trim()).filter(Boolean);
            const validProtocols = ['TCP', 'UDP', 'ICMP', 'Any'];
            
            for (const protocol of protocols) {
                if (!validProtocols.includes(protocol)) {
                    rule.protocolsError = `Invalid protocol: "${protocol}". Use TCP, UDP, ICMP, or Any`;
                    return;
                }
            }
            rule.protocolsError = '';
        },

        validatePorts(rule, value) {
            if (!value || !value.trim()) {
                rule.portsError = 'Ports are required';
                return;
            }
            
            const ports = value.split(',').map(p => p.trim()).filter(Boolean);
            for (const port of ports) {
                // Check for port ranges (e.g., 8080-8090)
                if (port.includes('-')) {
                    const [start, end] = port.split('-').map(p => p.trim());
                    if (isNaN(parseInt(start)) || isNaN(parseInt(end))) {
                        rule.portsError = `Invalid port range: "${port}"`;
                        return;
                    }
                    if (parseInt(start) > parseInt(end)) {
                        rule.portsError = `Invalid range: "${port}" (start > end)`;
                        return;
                    }
                } else if (isNaN(parseInt(port))) {
                    rule.portsError = `Invalid port: "${port}". Must be a number`;
                    return;
                }
            }
            rule.portsError = '';
        },

        removeApplicationRule(index) {
            this.form.application_rules.rules.splice(index, 1);
        },

        addNetworkRule() {
            this.form.network_rules.rules.push({
                name: '',
                ritm_number: '',
                description: '',
                protocols: '',
                source_ip_addresses: '',
                source_ip_groups: '',
                destination_ip_addresses: '',
                destination_ip_groups: '',
                destination_ports: '',
                destination_fqdns: '',
                // Error tracking
                nameError: '',
                protocolsError: '',
                portsError: ''
            });
            this.activeTab = 'network';
        },

        removeNetworkRule(index) {
            this.form.network_rules.rules.splice(index, 1);
        },

        addNatRule() {
            this.form.nat_rules.rules.push({
                name: '',
                ritm_number: '',
                description: '',
                protocols: '',
                source_ip_addresses: '',
                source_ip_groups: '',
                destination_address: '',
                destination_ports: '',
                translated_address: '',
                translated_port: null,
                // Error tracking
                nameError: '',
                protocolsError: '',
                portsError: ''
            });
            this.activeTab = 'nat';
        },

        removeNatRule(index) {
            this.form.nat_rules.rules.splice(index, 1);
        },

        parseProtocols(text) {
            // Parse "Https:443, Http:80" into [{ type: "Https", port: 443 }, ...]
            if (!text || typeof text !== 'string') return [];
            
            return text.split(',').map(p => {
                const trimmed = p.trim();
                if (!trimmed.includes(':')) {
                    console.error(`Invalid protocol format: "${trimmed}". Expected format: "Https:443" or "Http:80"`);
                    return null;
                }
                const [type, port] = trimmed.split(':');
                if (!type || !port) {
                    console.error(`Invalid protocol format: "${trimmed}". Both protocol type and port are required.`);
                    return null;
                }
                return { type: type.trim(), port: parseInt(port.trim(), 10) };
            }).filter(p => p && p.type && !isNaN(p.port));
        },

        splitCSV(text) {
            return text ? text.split(',').map(s => s.trim()).filter(Boolean) : [];
        },

        buildPayload() {
            try {
                const payload = {
                    source_application_id: this.form.source_application_id || null,
                    collection_name: (this.form.collection_name || '').trim(),
                    application_name: (this.form.application_name || '').trim(),
                    organization: (this.form.organization || '').trim(),
                    lob: (this.form.lob || '').trim(),
                    platform: this.form.platform || '',
                    environment_scopes: this.form.environment_scopes || [],
                    justification: (this.form.justification || '').trim(),
                    requested_effective_date: this.form.requested_effective_date || null,
                    expires_at: this.form.expires_at || null,
                    github_pr_url: this.form.github_pr_url || null,
                    ip_groups: this.form.ip_groups_json ? JSON.parse(this.form.ip_groups_json) : {}
                };

            // Application rules
            if (this.form.application_rules.rules.length > 0) {
                payload.application_rules = {
                    action: this.form.application_rules.action,
                    priority: this.form.application_rules.priority || null,
                    rules: this.form.application_rules.rules.map(r => ({
                        name: r.name.trim(),
                        ritm_number: r.ritm_number ? r.ritm_number.trim() : null,
                        description: r.description ? r.description.trim() : null,
                        protocols: this.parseProtocols(r.protocols_text),
                        source_ip_addresses: this.splitCSV(r.source_ip_addresses),
                        source_ip_groups: this.splitCSV(r.source_ip_groups),
                        destination_fqdns: this.splitCSV(r.destination_fqdns),
                        destination_addresses: this.splitCSV(r.destination_addresses)
                    }))
                };
            }

            // Network rules
            if (this.form.network_rules.rules.length > 0) {
                payload.network_rules = {
                    action: this.form.network_rules.action,
                    priority: this.form.network_rules.priority || null,
                    rules: this.form.network_rules.rules.map(r => ({
                        name: r.name.trim(),
                        ritm_number: r.ritm_number ? r.ritm_number.trim() : null,
                        description: r.description ? r.description.trim() : null,
                        protocols: this.splitCSV(r.protocols),
                        source_ip_addresses: this.splitCSV(r.source_ip_addresses),
                        source_ip_groups: this.splitCSV(r.source_ip_groups),
                        destination_ip_addresses: this.splitCSV(r.destination_ip_addresses),
                        destination_ip_groups: this.splitCSV(r.destination_ip_groups),
                        destination_ports: this.splitCSV(r.destination_ports),
                        destination_fqdns: this.splitCSV(r.destination_fqdns)
                    }))
                };
            }

            // NAT rules
            if (this.form.nat_rules.rules.length > 0) {
                payload.nat_rules = {
                    action: this.form.nat_rules.action,
                    priority: this.form.nat_rules.priority || null,
                    rules: this.form.nat_rules.rules.map(r => ({
                        name: r.name.trim(),
                        ritm_number: r.ritm_number ? r.ritm_number.trim() : null,
                        description: r.description ? r.description.trim() : null,
                        protocols: this.splitCSV(r.protocols),
                        source_ip_addresses: this.splitCSV(r.source_ip_addresses),
                        source_ip_groups: this.splitCSV(r.source_ip_groups),
                        destination_address: r.destination_address.trim(),
                        destination_ports: this.splitCSV(r.destination_ports),
                        translated_address: r.translated_address.trim(),
                        translated_port: r.translated_port
                    }))
                };
            }

                return payload;
            } catch (error) {
                console.error('Error building payload:', error);
                throw new Error(`Failed to build request payload: ${error.message}. Check that all fields are filled correctly.`);
            }
        },

        validateForm() {
            const errors = [];

            // Validate required fields
            if (!this.form.collection_name.trim()) {
                errors.push({ field: 'Collection Name', message: 'Collection name is required' });
            }
            if (!this.form.application_name.trim()) {
                errors.push({ field: 'Application Name', message: 'Application name is required' });
            }
            if (!this.form.organization.trim()) {
                errors.push({ field: 'Organization', message: 'Organization is required' });
            }
            if (!this.form.lob.trim()) {
                errors.push({ field: 'Line of Business', message: 'Line of Business is required' });
            }
            if (!this.form.platform) {
                errors.push({ field: 'Platform', message: 'Platform selection is required' });
            }
            if (this.form.environment_scopes.length === 0) {
                errors.push({ field: 'Environment Scopes', message: 'Select at least one environment scope' });
            }
            if (!this.form.justification.trim()) {
                errors.push({ field: 'Justification', message: 'Justification is required' });
            } else if (this.form.justification.trim().length < 10) {
                errors.push({ field: 'Justification', message: 'Justification must be at least 10 characters long' });
            }

            // Validate at least one rule exists
            const totalRules = this.form.application_rules.rules.length + 
                               this.form.network_rules.rules.length + 
                               this.form.nat_rules.rules.length;
            if (totalRules === 0) {
                errors.push({ field: 'Rules', message: 'Add at least one application, network, or NAT rule' });
            }

            // Rule name pattern: 1-80 chars, only letters, numbers, underscores, hyphens
            const ruleNamePattern = /^[a-zA-Z0-9_-]{1,80}$/;

            // Validate application rules
            this.form.application_rules.rules.forEach((rule, idx) => {
                const ruleName = `Application Rule ${idx + 1}`;
                
                if (!rule.name.trim()) {
                    errors.push({ field: ruleName, message: 'Rule name is required' });
                } else if (!ruleNamePattern.test(rule.name.trim())) {
                    errors.push({ field: ruleName, message: 'Rule name must be 1-80 characters and contain only letters, numbers, underscores, or hyphens (no spaces)' });
                }
                
                if (!rule.protocols_text.trim()) {
                    errors.push({ field: ruleName, message: 'Protocols are required (e.g., Https:443, Http:80)' });
                } else {
                    // Validate protocol format
                    const protocols = rule.protocols_text.split(',').map(p => p.trim());
                    for (const protocol of protocols) {
                        if (!protocol.includes(':')) {
                            errors.push({ field: ruleName, message: `Invalid protocol format: "${protocol}". Must use format "Https:443" or "Http:80"` });
                            break;
                        }
                        const [type, port] = protocol.split(':');
                        if (!type || !port || isNaN(parseInt(port))) {
                            errors.push({ field: ruleName, message: `Invalid protocol: "${protocol}". Format must be "Type:Port" (e.g., Https:443)` });
                            break;
                        }
                    }
                }
                
                if (!rule.destination_fqdns.trim() && !rule.destination_addresses.trim()) {
                    errors.push({ field: ruleName, message: 'Either destination FQDNs or addresses required' });
                }
                
                // Validate FQDNs format if provided
                if (rule.destination_fqdns.trim()) {
                    const fqdns = rule.destination_fqdns.split(',').map(f => f.trim()).filter(Boolean);
                    fqdns.forEach(fqdn => {
                        // FQDN pattern: domain.com or *.domain.com or subdomain.domain.com
                        if (!fqdn.match(/^(\*\.)?[a-zA-Z0-9]([a-zA-Z0-9-]*[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]*[a-zA-Z0-9])?)*$/)) {
                            errors.push({ field: ruleName, message: `Invalid FQDN format: "${fqdn}". Use format like "example.com" or "*.example.com"` });
                        }
                    });
                }
            });

            // Validate network rules
            this.form.network_rules.rules.forEach((rule, idx) => {
                const ruleName = `Network Rule ${idx + 1}`;
                
                if (!rule.name.trim()) {
                    errors.push({ field: ruleName, message: 'Rule name is required' });
                } else if (!ruleNamePattern.test(rule.name.trim())) {
                    errors.push({ field: ruleName, message: 'Rule name must be 1-80 characters and contain only letters, numbers, underscores, or hyphens (no spaces)' });
                }
                
                if (!rule.protocols.trim()) {
                    errors.push({ field: ruleName, message: 'Protocols are required (e.g., TCP, UDP, ICMP)' });
                }
                
                if (!rule.destination_ports.trim()) {
                    errors.push({ field: ruleName, message: 'Destination ports are required (e.g., 443, 80-443, *)' });
                }
            });

            // Validate NAT rules
            this.form.nat_rules.rules.forEach((rule, idx) => {
                const ruleName = `NAT Rule ${idx + 1}`;
                
                if (!rule.name.trim()) {
                    errors.push({ field: ruleName, message: 'Rule name is required' });
                } else if (!ruleNamePattern.test(rule.name.trim())) {
                    errors.push({ field: ruleName, message: 'Rule name must be 1-80 characters and contain only letters, numbers, underscores, or hyphens (no spaces)' });
                }
                
                if (!rule.destination_address.trim()) {
                    errors.push({ field: ruleName, message: 'Destination address is required' });
                }
                
                if (!rule.translated_address.trim()) {
                    errors.push({ field: ruleName, message: 'Translated address is required' });
                }
            });

            return errors;
        },

        async submitRequest() {
            this.errorMessage = '';
            this.successMessage = '';
            this.validationErrors = [];

            // Validate form
            const validationErrors = this.validateForm();
            if (validationErrors.length > 0) {
                this.validationErrors = validationErrors;
                this.errorMessage = `Please fix ${validationErrors.length} validation error(s) below:`;
                // Scroll to top to show errors
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }

            this.submitting = true;
            try {
                const payload = this.buildPayload();
                console.log('Submitting firewall request:', payload);
                
                const response = await fetch('/api/requests/firewall', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Email': '{{ user_email }}',
                    },
                    body: JSON.stringify(payload),
                });

                if (response.ok) {
                    const data = await response.json();
                    this.successMessage = 'Firewall request submitted successfully. Redirecting...';
                    this.redirectUrl = `/requests/${data.app_id}`;
                    
                    // Automatically redirect after 1.5 seconds
                    setTimeout(() => {
                        window.location.href = this.redirectUrl;
                    }, 1500);
                } else {
                    // Server validation error
                    try {
                        const error = await response.json();
                        console.error('Server validation error:', error);
                        
                        if (error.details && Array.isArray(error.details)) {
                            // Pydantic validation errors
                            this.validationErrors = error.details.map(e => ({
                                field: e.loc ? e.loc.join(' → ') : 'Unknown field',
                                message: e.msg || e.message || 'Validation failed'
                            }));
                            this.errorMessage = `Server Validation Error: Please fix ${this.validationErrors.length} issue(s) below:`;
                        } else {
                            this.errorMessage = `Server Error: ${error.error || 'Failed to submit firewall request'}`;
                            this.validationErrors = [];
                        }
                    } catch (parseError) {
                        // Could not parse error response
                        this.errorMessage = `Server Error (HTTP ${response.status}): Unable to parse error response`;
                        console.error('Failed to parse error response:', parseError);
                    }
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } catch (error) {
                // Network or JavaScript error
                console.error('Failed to submit firewall request', error);
                console.error('Error details:', error.message, error.stack);
                console.error('Error stack trace:', error.stack);
                
                // Try to extract which line/field caused the error
                let fieldHint = '';
                if (error.stack) {
                    if (error.stack.includes('buildPayload')) {
                        fieldHint = ' Check your form data - a field may contain invalid characters or be empty.';
                    }
                    if (error.stack.includes('.trim()')) {
                        fieldHint = ' One of the text fields is undefined or null.';
                    }
                }
                
                if (error.message.includes('trim')) {
                    this.errorMessage = `❌ Client Error: A required field is missing or invalid.${fieldHint} Please ensure all required fields are filled.`;
                } else if (error.message.includes('fetch')) {
                    this.errorMessage = '❌ Network Error: Unable to reach the server. Please check your internet connection.';
                } else if (error.message.includes('JSON')) {
                    this.errorMessage = '❌ Data Error: Invalid JSON format in IP Groups field. Please check the JSON syntax.';
                } else {
                    this.errorMessage = `❌ Unexpected Error: ${error.message}${fieldHint}`;
                }
                
                // Add detailed error info to validation errors for debugging
                this.validationErrors = [{
                    field: 'Technical Details',
                    message: `Error: ${error.message}\nType: ${error.constructor.name}\nPlease check browser console for full details.`
                }];
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } finally {
                this.submitting = false;
            }
        }
    };
}
</script>
{% endblock %}
