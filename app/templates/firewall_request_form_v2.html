{% extends "base.html" %}
{% from "icons.html" import icon_submit, icon_spinner %}

{% block title %}New Firewall Request - TradeX Platform Onboarding{% endblock %}

{% block content %}
<div x-data="firewallRequestApp()" x-init="init()" class="container mx-auto py-8 px-4">
    <div class="max-w-6xl mx-auto space-y-6">
        <div class="flex items-start justify-between gap-6 flex-wrap">
            <div>
                <h1 class="text-3xl font-bold tracking-tight">New Firewall Request</h1>
                <p class="text-muted-foreground mt-2 max-w-2xl">
                    Submit structured firewall rule collections with automatic priority management and Terraform-style validation.
                </p>
            </div>
            <a href="{{ url_for('web.dashboard') }}" class="btn btn-muted">Back to Dashboard</a>
        </div>

        <!-- Alerts -->
        <template x-if="errorMessage">
            <div class="rounded-lg border-2 border-red-400 bg-red-50 dark:bg-red-900/20 p-5" role="alert">
                <div class="flex items-start gap-3">
                    <svg class="h-6 w-6 text-red-600" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-11.5a.75.75 0 10-1.5 0v4a.75.75 0 001.5 0v-4zm0 6a.75.75 0 10-1.5 0 .75.75 0 001.5 0z" clip-rule="evenodd" />
                    </svg>
                    <div class="space-y-1">
                        <h3 class="text-sm font-semibold text-red-800">Unable to submit request</h3>
                        <p class="text-sm text-red-700" x-text="errorMessage"></p>
                        <template x-if="validationErrors.length">
                            <ul class="mt-2 text-xs text-red-600 space-y-1 list-disc list-inside">
                                <template x-for="err in validationErrors" :key="err.msg">
                                    <li><span class="font-medium" x-text="err.loc.join(' â†’ ')"></span>: <span x-text="err.msg"></span></li>
                                </template>
                            </ul>
                        </template>
                    </div>
                </div>
            </div>
        </template>

        <template x-if="successMessage">
            <div class="rounded-lg border border-green-300 bg-green-50 p-4" role="alert">
                <div class="flex items-start gap-3">
                    <svg class="h-5 w-5 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-10.809a.75.75 0 10-1.214-.882l-3.54 4.866-1.773-1.773a.75.75 0 10-1.06 1.06l2.5 2.5a.75.75 0 001.14-.067l4-5.5z" clip-rule="evenodd" />
                    </svg>
                    <div>
                        <p class="text-sm font-medium text-green-800" x-text="successMessage"></p>
                        <a class="text-sm text-primary underline mt-1 block" :href="redirectUrl">View request details</a>
                    </div>
                </div>
            </div>
        </template>

        <form @submit.prevent="submitRequest" class="space-y-8">
            <!-- Request metadata -->
            <div class="card">
                <div class="p-6 space-y-6">
                    <h2 class="text-xl font-semibold">Request Details</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Source Application ID -->
                        <div class="space-y-2 md:col-span-2">
                            <label class="block text-sm font-medium">Source Application ID (optional)</label>
                            <input 
                                type="number" 
                                x-model.number="form.source_application_id" 
                                @change="loadSourceApplicationEnvironments"
                                class="input w-full" 
                                placeholder="Enter existing app ID to reuse collection and filter environments" 
                            />
                            <p class="text-xs text-muted-foreground">If provided, environment scopes will be filtered to those available for this application.</p>
                        </div>

                        <!-- Collection Name -->
                        <div class="space-y-2 md:col-span-2">
                            <label class="block text-sm font-medium">Rule Collection Name *</label>
                            <input 
                                type="text" 
                                x-model="form.collection_name" 
                                required 
                                class="input w-full" 
                                placeholder="e.g., tradex-orders-dev-collection"
                                pattern="^[a-z0-9]([a-z0-9-]{0,118}[a-z0-9])?$"
                                title="Lowercase alphanumeric with hyphens, 1-120 chars, cannot start/end with hyphen"
                            />
                            <p class="text-xs text-muted-foreground">Azure naming rules: lowercase, alphanumeric, hyphens only (1-120 characters).</p>
                        </div>

                        <!-- Application Name -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium">Application Name *</label>
                            <input type="text" x-model="form.application_name" required class="input w-full" placeholder="e.g., TradeX Orders Portal" />
                        </div>

                        <!-- Destination Service -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium">Destination Service *</label>
                            <input type="text" x-model="form.destination_service" required class="input w-full" placeholder="e.g., Azure Firewall / Private Endpoint" />
                        </div>

                        <!-- Organization -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium">Organization *</label>
                            <select x-model="form.organization" required class="input w-full">
                                <option value="">Select Organization</option>
                                <template x-for="org in lookupData.Organization" :key="org.id">
                                    <option :value="org.value" x-text="org.value"></option>
                                </template>
                            </select>
                        </div>

                        <!-- LOB -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium">Line of Business *</label>
                            <select x-model="form.lob" required class="input w-full">
                                <option value="">Select LOB</option>
                                <template x-for="lob in lookupData.LOB" :key="lob.id">
                                    <option :value="lob.value" x-text="lob.value"></option>
                                </template>
                            </select>
                        </div>

                        <!-- Environment Scopes -->
                        <div class="space-y-2 md:col-span-2">
                            <label class="block text-sm font-medium">Environment Scopes *</label>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
                                <template x-for="scope in availableEnvironmentScopes" :key="scope">
                                    <label class="flex items-center gap-2 rounded-lg border px-3 py-2 cursor-pointer"
                                           :class="form.environment_scopes.includes(scope) ? 'border-primary bg-primary/5' : 'border-border'">
                                        <input type="checkbox" class="checkbox" :value="scope" @change="toggleEnvironmentScope(scope)" :checked="form.environment_scopes.includes(scope)" />
                                        <span class="text-sm font-medium" x-text="scope"></span>
                                    </label>
                                </template>
                            </div>
                            <p class="text-xs text-muted-foreground" x-show="form.source_application_id">
                                Showing environments available for selected source application.
                            </p>
                        </div>

                        <!-- Dates -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium">Requested Effective Date</label>
                            <input type="date" x-model="form.requested_effective_date" class="input w-full" />
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium">Expiry Date</label>
                            <input type="date" x-model="form.expires_at" class="input w-full" />
                        </div>

                        <!-- Justification -->
                        <div class="space-y-2 md:col-span-2">
                            <label class="block text-sm font-medium">Business Justification *</label>
                            <textarea x-model="form.justification" rows="4" required class="input w-full resize-y" placeholder="Provide business need and impact if access is not granted."></textarea>
                        </div>

                        <!-- GitHub PR URL -->
                        <div class="space-y-2 md:col-span-2">
                            <label class="block text-sm font-medium">GitHub PR URL (auto-filled later)</label>
                            <input type="url" x-model="form.github_pr_url" class="input w-full" placeholder="https://github.com/org/repo/pull/123" readonly disabled />
                            <p class="text-xs text-muted-foreground">This field is populated automatically during deployment workflow.</p>
                        </div>

                        <!-- IP Groups (JSON) -->
                        <div class="space-y-2 md:col-span-2">
                            <label class="block text-sm font-medium">IP Groups (JSON, optional)</label>
                            <textarea x-model="form.ip_groups_json" rows="3" class="input w-full resize-y font-mono text-xs" placeholder='{"group1": ["10.0.0.0/24"], "group2": ["192.168.1.0/24"]}'></textarea>
                            <p class="text-xs text-muted-foreground">Reusable IP groups in JSON format. Leave empty if not needed.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rule Collection Tabs -->
            <div class="card">
                <div class="border-b border-border">
                    <nav class="flex gap-1 p-2">
                        <button 
                            type="button"
                            @click="activeTab = 'application'"
                            class="px-4 py-2 text-sm font-medium rounded transition"
                            :class="activeTab === 'application' ? 'bg-primary text-white' : 'hover:bg-muted'"
                        >
                            Application Rules <span class="ml-1 opacity-70" x-text="`(${form.application_rules.rules.length})`"></span>
                        </button>
                        <button 
                            type="button"
                            @click="activeTab = 'network'"
                            class="px-4 py-2 text-sm font-medium rounded transition"
                            :class="activeTab === 'network' ? 'bg-primary text-white' : 'hover:bg-muted'"
                        >
                            Network Rules <span class="ml-1 opacity-70" x-text="`(${form.network_rules.rules.length})`"></span>
                        </button>
                        <button 
                            type="button"
                            @click="activeTab = 'nat'"
                            class="px-4 py-2 text-sm font-medium rounded transition"
                            :class="activeTab === 'nat' ? 'bg-primary text-white' : 'hover:bg-muted'"
                        >
                            NAT Rules <span class="ml-1 opacity-70" x-text="`(${form.nat_rules.rules.length})`"></span>
                        </button>
                    </nav>
                </div>

                <!-- Application Rules Tab -->
                <div x-show="activeTab === 'application'" class="p-6 space-y-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-semibold">Application Rules</h3>
                            <p class="text-sm text-muted-foreground">FQDN-based filtering for L7 application traffic</p>
                        </div>
                        <button type="button" class="btn btn-sm btn-muted" @click="addApplicationRule">+ Add Rule</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-4">
                        <div class="space-y-2">
                            <label class="text-sm font-medium">Action</label>
                            <select x-model="form.application_rules.action" class="input w-full">
                                <option value="Allow">Allow</option>
                                <option value="Deny">Deny</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium">Priority (optional, auto-calculated)</label>
                            <input type="number" x-model.number="form.application_rules.priority" class="input w-full" placeholder="Auto" min="100" max="65000" step="100" />
                        </div>
                    </div>
                    <div class="space-y-3">
                        <template x-for="(rule, index) in form.application_rules.rules" :key="index">
                            <div class="border border-border rounded-lg p-4 space-y-3 bg-muted/10">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium">Rule <span x-text="index + 1"></span></span>
                                    <button type="button" class="text-xs text-red-600 hover:underline" @click="removeApplicationRule(index)">Remove</button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium">Name *</label>
                                        <input type="text" x-model="rule.name" required class="input input-sm w-full" placeholder="rule-name" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium">RITM Number</label>
                                        <input type="text" x-model="rule.ritm_number" class="input input-sm w-full" placeholder="RITM0012345" />
                                    </div>
                                    <div class="space-y-1 md:col-span-2">
                                        <label class="text-xs font-medium">Description</label>
                                        <input type="text" x-model="rule.description" class="input input-sm w-full" placeholder="Purpose of this rule" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium">Source IPs * (comma-separated)</label>
                                        <input type="text" x-model="rule.source_ip_addresses" required class="input input-sm w-full" placeholder="10.0.0.0/24, 192.168.1.0/24" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium">Source IP Groups (comma-separated)</label>
                                        <input type="text" x-model="rule.source_ip_groups" class="input input-sm w-full" placeholder="group1, group2" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium">Destination FQDNs (comma-separated)</label>
                                        <input type="text" x-model="rule.destination_fqdns" class="input input-sm w-full" placeholder="*.example.com, api.service.com" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium">Destination Addresses (comma-separated)</label>
                                        <input type="text" x-model="rule.destination_addresses" class="input input-sm w-full" placeholder="203.0.113.0/24" />
                                    </div>
                                    <div class="space-y-1 md:col-span-2">
                                        <label class="text-xs font-medium">Protocols * (format: Https:443, Http:80)</label>
                                        <input type="text" x-model="rule.protocols_text" required class="input input-sm w-full" placeholder="Https:443, Http:80" />
                                        <p class="text-xs text-muted-foreground">Format: Type:Port, Type:Port (e.g., Https:443, Http:80, Mssql:1433)</p>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Network Rules Tab -->
                <div x-show="activeTab === 'network'" class="p-6 space-y-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-semibold">Network Rules</h3>
                            <p class="text-sm text-muted-foreground">IP-based L3/L4 filtering for network traffic</p>
                        </div>
                        <button type="button" class="btn btn-sm btn-muted" @click="addNetworkRule">+ Add Rule</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-4">
                        <div class="space-y-2">
                            <label class="text-sm font-medium">Action</label>
                            <select x-model="form.network_rules.action" class="input w-full">
                                <option value="Allow">Allow</option>
                                <option value="Deny">Deny</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium">Priority (optional, auto-calculated)</label>
                            <input type="number" x-model.number="form.network_rules.priority" class="input w-full" placeholder="Auto" min="100" max="65000" step="100" />
                        </div>
                    </div>
                    <div class="space-y-3">
                        <template x-for="(rule, index) in form.network_rules.rules" :key="index">
                            <div class="border border-border rounded-lg p-4 space-y-3 bg-muted/10">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium">Rule <span x-text="index + 1"></span></span>
                                    <button type="button" class="text-xs text-red-600 hover:underline" @click="removeNetworkRule(index)">Remove</button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium">Name *</label>
                                        <input type="text" x-model="rule.name" required class="input input-sm w-full" placeholder="rule-name" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium">RITM Number</label>
                                        <input type="text" x-model="rule.ritm_number" class="input input-sm w-full" placeholder="RITM0012345" />
                                    </div>
                                    <div class="space-y-1 md:col-span-2">
                                        <label class="text-xs font-medium">Description</label>
                                        <input type="text" x-model="rule.description" class="input input-sm w-full" placeholder="Purpose of this rule" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium">Protocols * (TCP, UDP, ICMP, etc.)</label>
                                        <input type="text" x-model="rule.protocols" required class="input input-sm w-full" placeholder="TCP, UDP" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium">Destination Ports *</label>
                                        <input type="text" x-model="rule.destination_ports" required class="input input-sm w-full" placeholder="443, 80, 1000-2000" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium">Source IPs *</label>
                                        <input type="text" x-model="rule.source_ip_addresses" required class="input input-sm w-full" placeholder="10.0.0.0/24" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium">Source IP Groups</label>
                                        <input type="text" x-model="rule.source_ip_groups" class="input input-sm w-full" placeholder="group1, group2" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium">Destination IPs *</label>
                                        <input type="text" x-model="rule.destination_ip_addresses" required class="input input-sm w-full" placeholder="203.0.113.0/24" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium">Destination IP Groups</label>
                                        <input type="text" x-model="rule.destination_ip_groups" class="input input-sm w-full" placeholder="group3, group4" />
                                    </div>
                                    <div class="space-y-1 md:col-span-2">
                                        <label class="text-xs font-medium">Destination FQDNs</label>
                                        <input type="text" x-model="rule.destination_fqdns" class="input input-sm w-full" placeholder="*.example.com" />
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- NAT Rules Tab -->
                <div x-show="activeTab === 'nat'" class="p-6 space-y-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-semibold">NAT Rules</h3>
                            <p class="text-sm text-muted-foreground">DNAT rules for address/port translation</p>
                        </div>
                        <button type="button" class="btn btn-sm btn-muted" @click="addNatRule">+ Add Rule</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-4">
                        <div class="space-y-2">
                            <label class="text-sm font-medium">Action</label>
                            <select x-model="form.nat_rules.action" class="input w-full">
                                <option value="Dnat">Dnat</option>
                                <option value="Snat">Snat</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium">Priority (optional, auto-calculated)</label>
                            <input type="number" x-model.number="form.nat_rules.priority" class="input w-full" placeholder="Auto" min="100" max="65000" step="100" />
                        </div>
                    </div>
                    <div class="space-y-3">
                        <template x-for="(rule, index) in form.nat_rules.rules" :key="index">
                            <div class="border border-border rounded-lg p-4 space-y-3 bg-muted/10">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium">Rule <span x-text="index + 1"></span></span>
                                    <button type="button" class="text-xs text-red-600 hover:underline" @click="removeNatRule(index)">Remove</button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium">Name *</label>
                                        <input type="text" x-model="rule.name" required class="input input-sm w-full" placeholder="rule-name" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium">RITM Number</label>
                                        <input type="text" x-model="rule.ritm_number" class="input input-sm w-full" placeholder="RITM0012345" />
                                    </div>
                                    <div class="space-y-1 md:col-span-2">
                                        <label class="text-xs font-medium">Description</label>
                                        <input type="text" x-model="rule.description" class="input input-sm w-full" placeholder="Purpose of this rule" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium">Protocols * (TCP, UDP)</label>
                                        <input type="text" x-model="rule.protocols" required class="input input-sm w-full" placeholder="TCP, UDP" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium">Source IPs *</label>
                                        <input type="text" x-model="rule.source_ip_addresses" required class="input input-sm w-full" placeholder="10.0.0.0/24" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium">Source IP Groups</label>
                                        <input type="text" x-model="rule.source_ip_groups" class="input input-sm w-full" placeholder="group1, group2" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium">Destination Address *</label>
                                        <input type="text" x-model="rule.destination_address" required class="input input-sm w-full" placeholder="203.0.113.10" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium">Destination Ports *</label>
                                        <input type="text" x-model="rule.destination_ports" required class="input input-sm w-full" placeholder="443, 80" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium">Translated Address *</label>
                                        <input type="text" x-model="rule.translated_address" required class="input input-sm w-full" placeholder="10.0.1.10" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium">Translated Port *</label>
                                        <input type="number" x-model.number="rule.translated_port" required class="input input-sm w-full" placeholder="443" min="1" max="65535" />
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Submission -->
            <div class="flex flex-col sm:flex-row gap-3 justify-end">
                <a href="{{ url_for('web.dashboard') }}" class="btn btn-muted text-center">Cancel</a>
                <button type="submit" class="btn btn-primary" :disabled="submitting">
                    <span x-show="!submitting" class="flex items-center gap-2">
                        {{ icon_submit() }} Submit for Approval
                    </span>
                    <span x-show="submitting" class="flex items-center gap-2">
                        {{ icon_spinner() }} Submitting...
                    </span>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function firewallRequestApp() {
    return {
        lookupData: { Organization: [], LOB: [], Environment: [] },
        availableEnvironmentScopes: ['DEV', 'TEST', 'QA', 'STAGE', 'UAT', 'PROD', 'DR'],
        activeTab: 'application',
        form: {
            source_application_id: null,
            collection_name: '',
            application_name: '',
            organization: '',
            lob: '',
            platform: 'Azure',
            environment_scopes: [],
            destination_service: '',
            justification: '',
            requested_effective_date: '',
            expires_at: '',
            github_pr_url: '',
            ip_groups_json: '',
            application_rules: {
                action: 'Allow',
                priority: null,
                rules: []
            },
            network_rules: {
                action: 'Allow',
                priority: null,
                rules: []
            },
            nat_rules: {
                action: 'Dnat',
                priority: null,
                rules: []
            }
        },
        submitting: false,
        successMessage: '',
        errorMessage: '',
        validationErrors: [],
        redirectUrl: '#',

        async init() {
            await this.loadLookupData();
        },

        async loadLookupData() {
            try {
                const response = await fetch('/api/lookup');
                const data = await response.json();
                this.lookupData = data || { Organization: [], LOB: [], Environment: [] };
            } catch (error) {
                console.error('Failed to load lookup data', error);
            }
        },

        async loadSourceApplicationEnvironments() {
            if (!this.form.source_application_id) {
                this.availableEnvironmentScopes = ['DEV', 'TEST', 'QA', 'STAGE', 'UAT', 'PROD', 'DR'];
                return;
            }

            try {
                const response = await fetch(`/api/requests/${this.form.source_application_id}`);
                if (response.ok) {
                    const data = await response.json();
                    const envs = data.environments || [];
                    this.availableEnvironmentScopes = envs.map(e => e.environment_name.toUpperCase());
                    // Clear environment scopes that are no longer available
                    this.form.environment_scopes = this.form.environment_scopes.filter(s => this.availableEnvironmentScopes.includes(s));
                } else {
                    console.warn('Could not load source application details');
                    this.availableEnvironmentScopes = ['DEV', 'TEST', 'QA', 'STAGE', 'UAT', 'PROD', 'DR'];
                }
            } catch (error) {
                console.error('Failed to load source application', error);
                this.availableEnvironmentScopes = ['DEV', 'TEST', 'QA', 'STAGE', 'UAT', 'PROD', 'DR'];
            }
        },

        toggleEnvironmentScope(scope) {
            if (this.form.environment_scopes.includes(scope)) {
                this.form.environment_scopes = this.form.environment_scopes.filter(s => s !== scope);
            } else {
                this.form.environment_scopes.push(scope);
            }
        },

        addApplicationRule() {
            this.form.application_rules.rules.push({
                name: '',
                ritm_number: '',
                description: '',
                protocols_text: '',
                source_ip_addresses: '',
                source_ip_groups: '',
                destination_fqdns: '',
                destination_addresses: ''
            });
            this.activeTab = 'application';
        },

        removeApplicationRule(index) {
            this.form.application_rules.rules.splice(index, 1);
        },

        addNetworkRule() {
            this.form.network_rules.rules.push({
                name: '',
                ritm_number: '',
                description: '',
                protocols: '',
                source_ip_addresses: '',
                source_ip_groups: '',
                destination_ip_addresses: '',
                destination_ip_groups: '',
                destination_ports: '',
                destination_fqdns: ''
            });
            this.activeTab = 'network';
        },

        removeNetworkRule(index) {
            this.form.network_rules.rules.splice(index, 1);
        },

        addNatRule() {
            this.form.nat_rules.rules.push({
                name: '',
                ritm_number: '',
                description: '',
                protocols: '',
                source_ip_addresses: '',
                source_ip_groups: '',
                destination_address: '',
                destination_ports: '',
                translated_address: '',
                translated_port: null
            });
            this.activeTab = 'nat';
        },

        removeNatRule(index) {
            this.form.nat_rules.rules.splice(index, 1);
        },

        parseProtocols(text) {
            // Parse "Https:443, Http:80" into [{ type: "Https", port: 443 }, ...]
            return text.split(',').map(p => {
                const [type, port] = p.trim().split(':');
                return { type: type.trim(), port: parseInt(port.trim(), 10) };
            }).filter(p => p.type && !isNaN(p.port));
        },

        splitCSV(text) {
            return text ? text.split(',').map(s => s.trim()).filter(Boolean) : [];
        },

        buildPayload() {
            const payload = {
                source_application_id: this.form.source_application_id || null,
                collection_name: this.form.collection_name.trim(),
                application_name: this.form.application_name.trim(),
                organization: this.form.organization.trim(),
                lob: this.form.lob.trim(),
                platform: this.form.platform,
                environment_scopes: this.form.environment_scopes,
                destination_service: this.form.destination_service.trim(),
                justification: this.form.justification.trim(),
                requested_effective_date: this.form.requested_effective_date || null,
                expires_at: this.form.expires_at || null,
                github_pr_url: this.form.github_pr_url || null,
                ip_groups: this.form.ip_groups_json ? JSON.parse(this.form.ip_groups_json) : null
            };

            // Application rules
            if (this.form.application_rules.rules.length > 0) {
                payload.application_rules = {
                    action: this.form.application_rules.action,
                    priority: this.form.application_rules.priority || null,
                    rules: this.form.application_rules.rules.map(r => ({
                        name: r.name.trim(),
                        ritm_number: r.ritm_number ? r.ritm_number.trim() : null,
                        description: r.description ? r.description.trim() : null,
                        protocols: this.parseProtocols(r.protocols_text),
                        source_ip_addresses: this.splitCSV(r.source_ip_addresses),
                        source_ip_groups: this.splitCSV(r.source_ip_groups),
                        destination_fqdns: this.splitCSV(r.destination_fqdns),
                        destination_addresses: this.splitCSV(r.destination_addresses)
                    }))
                };
            }

            // Network rules
            if (this.form.network_rules.rules.length > 0) {
                payload.network_rules = {
                    action: this.form.network_rules.action,
                    priority: this.form.network_rules.priority || null,
                    rules: this.form.network_rules.rules.map(r => ({
                        name: r.name.trim(),
                        ritm_number: r.ritm_number ? r.ritm_number.trim() : null,
                        description: r.description ? r.description.trim() : null,
                        protocols: this.splitCSV(r.protocols),
                        source_ip_addresses: this.splitCSV(r.source_ip_addresses),
                        source_ip_groups: this.splitCSV(r.source_ip_groups),
                        destination_ip_addresses: this.splitCSV(r.destination_ip_addresses),
                        destination_ip_groups: this.splitCSV(r.destination_ip_groups),
                        destination_ports: this.splitCSV(r.destination_ports),
                        destination_fqdns: this.splitCSV(r.destination_fqdns)
                    }))
                };
            }

            // NAT rules
            if (this.form.nat_rules.rules.length > 0) {
                payload.nat_rules = {
                    action: this.form.nat_rules.action,
                    priority: this.form.nat_rules.priority || null,
                    rules: this.form.nat_rules.rules.map(r => ({
                        name: r.name.trim(),
                        ritm_number: r.ritm_number ? r.ritm_number.trim() : null,
                        description: r.description ? r.description.trim() : null,
                        protocols: this.splitCSV(r.protocols),
                        source_ip_addresses: this.splitCSV(r.source_ip_addresses),
                        source_ip_groups: this.splitCSV(r.source_ip_groups),
                        destination_address: r.destination_address.trim(),
                        destination_ports: this.splitCSV(r.destination_ports),
                        translated_address: r.translated_address.trim(),
                        translated_port: r.translated_port
                    }))
                };
            }

            return payload;
        },

        async submitRequest() {
            this.errorMessage = '';
            this.successMessage = '';
            this.validationErrors = [];

            if (this.form.environment_scopes.length === 0) {
                this.errorMessage = 'Select at least one environment scope.';
                return;
            }

            const totalRules = this.form.application_rules.rules.length + 
                               this.form.network_rules.rules.length + 
                               this.form.nat_rules.rules.length;
            if (totalRules === 0) {
                this.errorMessage = 'Add at least one rule before submitting.';
                return;
            }

            this.submitting = true;
            try {
                const payload = this.buildPayload();
                const response = await fetch('/api/requests/firewall', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Email': '{{ user_email }}',
                    },
                    body: JSON.stringify(payload),
                });

                if (response.ok) {
                    const data = await response.json();
                    this.successMessage = 'Firewall request submitted successfully.';
                    this.redirectUrl = `/requests/${data.app_id}`;
                } else {
                    const error = await response.json();
                    this.errorMessage = error.error || 'Failed to submit firewall request.';
                    this.validationErrors = error.details || [];
                }
            } catch (error) {
                console.error('Failed to submit firewall request', error);
                this.errorMessage = 'Unexpected error occurred while submitting the request.';
            } finally {
                this.submitting = false;
            }
        }
    };
}
</script>
{% endblock %}
